---
title: 'Summary of simulation results from SCRAM: a stochastic collision risk assessment for movement data'
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
params:
  SCRAM_version: NA
  project: NA
  modeler: NA
  run_start_time: NA
  run_end_time: NA
  iterations: NA
  model_output: NA
  threshold: NA
  prob_exceed: NA
  option: NA
  species_labels: NA
  species_popn_data: NA
  species_popn_assumptions: NA
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyfoot[LO,LE]{`r params$project`, `r params$modeler`}
  - \fancyhead[RO,RE]{SCRAM v. `r params$SCRAM_version`}
  - \fancyfoot[CO,CE]{`r params$run_end_time`}
  - \fancyfoot[LE,RO]{\thepage}
---
<!-- header-includes required because won't re-run after first report download -->
<!-- Fix: https://stackoverflow.com/questions/46080853/why-does-rendering-a-pdf-from-rmarkdown-require-closing-rstudio-between-renders/46083308#46083308 -->

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
options(tinytex.verbose = TRUE)

```

\begin{center}
\includegraphics[width=1\textwidth]{SCRAM_logo_2_4inch.jpg}
\end{center}

<br>
<br>

SCRAM was developed by Biodiversity Research Institute, the University of Rhode Island, and the U.S. Fish and Wildlife Service with funding from the Bureau of Ocean Energy Management.

<br>
<br>

\begin{center}
\includegraphics[width=0.2\textwidth]{BRI_color_logo_no_words.png}
\includegraphics[width=0.2\textwidth]{URI.png}
\includegraphics[width=0.1\textwidth]{USFWS.png}
\includegraphics[width=0.2\textwidth]{BOEM.png}
\end{center}

<br>
<br>

\newpage

## SCRAM run details 

<br>
<br>


```{r, echo=FALSE, warning=FALSE, message = FALSE}
  
option_names <-  c("Option 1: faster approximation", NA,"Option 3: slower but more accurate assessment")

cat(paste0("SCRAM - the Stochastic Collision Risk Assessment for Movement version ", params$SCRAM_version,"\nwas run for ", params$iterations, " iterations using ", option_names[as.numeric(params$option)], "\n", 
          "Project: ", params$project, "\n",
          "Modeler: ", params$modeler, "\n",
          "The model run was started at: ",  format(params$run_start_time, "%a %b %d %X %Y %Z", tz = "America/New_York"), "\n",
          "The model run was completed at: ",  format(params$run_end_time, "%a %b %d %X %Y %Z", tz = "America/New_York"), "\n",
          paste0(params$prob_exceed, collapse="\n")), sep = "")

```

\newpage

## Model inputs used for this analysis

<br>
<br>

```{r, table1, echo=FALSE, message=FALSE, warning=FALSE}
num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
sampled_subset <- subset(
  params$model_output[['sampledParamsBird']][[params$model_output[['CRSpecies']][1]]][[1]])
  #,
  #select=-c(AvoidanceBasic))
n_table_cols <- length(sampled_subset[1,])
col_names <- colnames(sampled_subset)
#col_names[col_names == "AvoidanceExtended"] <- "Avoidance"
bird_params_table <- mat.or.vec(num_species*num_turb_mods, (n_table_cols + 2))

for(e in 1:num_species){
  for(i in 1:num_turb_mods){
    index_a <- (num_turb_mods*e) - (num_turb_mods - i)
    # bird_params_table[index_a, 1] <- params$model_output[['CRSpecies']][e]
    bird_params_table[index_a, 1] <- gsub("_", " ", params$model_output[['CRSpecies']][e])
    bird_params_table[index_a, 2] <- rev(params$model_output[['Turbines']])[i]
    for(z in 1:n_table_cols){
      if(params$option == "1"){
        bird_params_temp <- subset(
          params$model_output[['sampledParamsBird']][[params$model_output[['CRSpecies']][e]]][[num_turb_mods-(i-1)]])[,z]
          #,
          #select=-c(AvoidanceExtended))[,z]
      }else{
        bird_params_temp <- subset(
          params$model_output[['sampledParamsBird']][[params$model_output[['CRSpecies']][e]]][[num_turb_mods-(i-1)]])[,z]
          #,
          #select=-c(AvoidanceBasic))[,z]
      }
      mean_temp <- round(mean(bird_params_temp), 2)
      lower_temp <- round(quantile(bird_params_temp, c(.025)), 2)
      upper_temp <- round(quantile(bird_params_temp, c(.975)), 2)
      bird_params_table[index_a, (z + 2)] <- paste(mean_temp, " (", lower_temp, ", ", upper_temp, ")", sep="")
    }
  }
}
colnames(bird_params_table) <- c("Species", "Turbine model", "Avoidance", "Wing span", "Body length", "Speed")
bird_params_table <- as.data.frame(bird_params_table)
bird_params_table <- bird_params_table[order(bird_params_table$Species, bird_params_table$`Turbine model`),]

#https://stackoverflow.com/questions/53153537/rmarkdown-setting-the-position-of-kable
#if you find HOLD_position is not powerful enough to literally PIN your table in the exact position, you may want to 
# use HOLD_position, which is a more powerful version of this feature
# percent symbol causing issues in caption
kbl(bird_params_table, booktabs=T, caption = "Species input parameters (mean and 95 perc. range).", row.names = F) %>%
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2,bold=T,color="blue",width = "0.75in") %>% 
  column_spec(3:6,width = "1in")

```
<br>
<br>

```{r, table2, echo=FALSE, message=FALSE, warning=FALSE}
popn_tbl_compact <- params$species_popn_data
for (month in month.abb){
  popn_tbl_compact[[month]] = paste(popn_tbl_compact[[month]], "\u00B1" ,popn_tbl_compact[[paste0(month, "SD")]])
}
popn_tbl_compact$Species <- gsub("_", " ",popn_tbl_compact$Species)
popn_tbl_compact <- popn_tbl_compact %>% 
  dplyr::select(c("Species", month.abb))


kbl(popn_tbl_compact[,c(1:7)], booktabs=T, caption = "Species monthly (Jan-Jun) population estimates \u00B1 SD and assumptions/limitations as specified by the USFWS using the most recent data.", row.names = F) %>%
  # footnote(general= "Population data assumptions/limitations",number=params$species_popn_assumptions, threeparttable=T) %>% 
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2:7,width = "0.75in")

```

<br>
<br>

```{r, table3, echo=FALSE, message=FALSE, warning=FALSE}
#add footnotes
notes <- paste0(1:length(params$species_popn_assumptions),") ", params$species_popn_assumptions)
  
kbl(popn_tbl_compact[, c(1, 8:13)], booktabs=T, caption = "Species monthly (Jul-Dec) population estimates \u00B1 SD and assumptions/limitations as specified by the USFWS using the most recent data.", row.names = F) %>%
  footnote(general = notes, general_title="Population data assumptions/limitations:", threeparttable=T) %>% 
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2:7,width = "0.75in")

```

<br>
<br>
```{r, table4, echo=FALSE, warning=FALSE, message = FALSE}

#ATG - 030422 - slight change to format tables
num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
sampled_subset <- subset(
  params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][1]]][[1]], 
  select=c(Num_Turbines, RotorRadius_m, HubHeight_m, BladeWidth_m, WindSpeed_mps))
n_table_cols1 <- length(sampled_subset[1,])

col_names <- colnames(sampled_subset)
#turb_params_table <- mat.or.vec(num_species*num_turb_mods, (n_table_cols + 2))
turb_params_table <- mat.or.vec(num_species*num_turb_mods, (n_table_cols1 + 2))

for(e in 1:num_species){
  for(i in 1:num_turb_mods){
    index_a <- (num_turb_mods*e) - (num_turb_mods - i)
    turb_params_table[index_a, 1] <- gsub("_", " ", params$model_output[['CRSpecies']][e])
    turb_params_table[index_a, 2] <- rev(params$model_output[['Turbines']])[i]
    for(z in 1:n_table_cols1){
      turb_params_temp <- subset(
        params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][e]]][[num_turb_mods-(i-1)]], 
        select=c(Num_Turbines, RotorRadius_m, HubHeight_m, BladeWidth_m, WindSpeed_mps))[, z]
      mean_temp <- round(mean(turb_params_temp), 2)
      lower_temp <- round(quantile(turb_params_temp, c(.025)), 2)
      upper_temp <- round(quantile(turb_params_temp, c(.975)), 2)
      turb_params_table[index_a, (z + 2)] <- paste(mean_temp, " (", lower_temp, ", ", upper_temp, ")", sep="")
    }
  }
}
colnames(turb_params_table) <- c("Species", "Turbine model", "Num. turbines", "Rotor radius", "Hub height (m)", "Blade width (m)", "Wind speed (mps)")
turb_params_table <- as.data.frame(turb_params_table)
turb_params_table <- turb_params_table[order(turb_params_table$Species, turb_params_table$`Turbine model`),]

kbl(turb_params_table, booktabs=T, caption = "Wind farm input parameters (mean and 95 perc. range).", row.names = F) %>%
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2,bold=T,color="blue",width = "0.75in") %>% 
  column_spec(3:7,width = "0.75in")

```
<br>
<br>

```{r, table5, echo=FALSE, warning=FALSE, message = FALSE}
num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
sampled_subset <- subset(
  params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][1]]][[1]], 
  select=c(Prop_Upwind, RotorSpeed_rpm, Pitch_rad, WFWidth_km, Latitude, Longitude))
n_table_cols2 <- length(sampled_subset[1,])

col_names <- colnames(sampled_subset)
#turb_params_table <- mat.or.vec(num_species*num_turb_mods, (n_table_cols + 2))
turb_params_table2 <- mat.or.vec(num_species*num_turb_mods, (n_table_cols2 + 2))

for(e in 1:num_species){
  for(i in 1:num_turb_mods){
    index_a <- (num_turb_mods*e) - (num_turb_mods - i)
    turb_params_table2[index_a, 1] <- gsub("_", " ", params$model_output[['CRSpecies']][e])
    turb_params_table2[index_a, 2] <- rev(params$model_output[['Turbines']])[i]
    for(z in 1:n_table_cols2){
      turb_params_temp2 <- subset(
        params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][e]]][[num_turb_mods-(i-1)]],
        select=c(Prop_Upwind, RotorSpeed_rpm, Pitch_rad, WFWidth_km, Latitude, Longitude))[, z]
      if(z<5){
      mean_temp2 <- round(mean(turb_params_temp2), 2)
      lower_temp2 <- round(quantile(turb_params_temp2, c(.025)), 2)
      upper_temp2 <- round(quantile(turb_params_temp2, c(.975)), 2)
      turb_params_table2[index_a, (z + 2)] <- paste(mean_temp2, " (", lower_temp2, ", ", upper_temp2, ")", sep="")
      } else {
        #skip lat/long columns
              turb_params_table2[index_a, (z + 2)] <- round(mean(turb_params_temp2), 2)

      }
    }
  }
}
colnames(turb_params_table2) <- c("Species", "Turbine model","Prop. upwind", "Rotor speed (rpm)", "Pitch (radians)", "Farm width (km)", "Lat.", "Long.")
turb_params_table2 <- as.data.frame(turb_params_table2)
turb_params_table2 <- turb_params_table2[order(turb_params_table2$Species, turb_params_table2$`Turbine model`),]

kbl(turb_params_table2, booktabs=T, caption = "Wind farm input parameters (mean and 95 perc. range).", row.names = F) %>%
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2,bold=T,color="blue",width = "0.70in") %>% 
  column_spec(3:8,width = "0.65in")

```
<br>
<br>

```{r, table6, echo=FALSE, warning=FALSE, message = FALSE}
#ATG - 030422 - slight change to format tables, split into 2
num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
sampled_subset <- subset(
  params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][1]]][[1]],
  select=c(JanOp,FebOp,MarOp,AprOp,MayOp,JunOp))
# n_table_cols <- length(sampled_subset[1,])
n_table_cols_pt1 <- length(sampled_subset[1,])
col_names <- colnames(sampled_subset)
turb_params_table_pt1 <- mat.or.vec(num_species*num_turb_mods, (n_table_cols_pt1 + 2))

for(e in 1:num_species){
  for(i in 1:num_turb_mods){
    index_a <- (num_turb_mods*e) - (num_turb_mods - i)
    turb_params_table_pt1[index_a, 1] <- gsub("_", " ", params$model_output[['CRSpecies']][e])
    turb_params_table_pt1[index_a, 2] <- rev(params$model_output[['Turbines']])[i]
    for(z in 1:n_table_cols_pt1){
      turb_params_temp <- subset(
        params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][e]]][[num_turb_mods-(i-1)]], 
        select=c(JanOp,FebOp,MarOp,AprOp,MayOp,JunOp))[, z]
      mean_temp <- round(mean(turb_params_temp), 1)
      lower_temp <- round(quantile(turb_params_temp, c(.025)), 1)
      upper_temp <- round(quantile(turb_params_temp, c(.975)), 1)
      
      turb_params_table_pt1[index_a, (z + 2)] <- paste(mean_temp, " (", lower_temp, ", ", upper_temp, ")", sep="")
    }
  }
}
colnames(turb_params_table_pt1) <- c("Species", "Turbine model", "Jan Op.", "Feb Op.", "Mar Op.", "Apr Op.", "May Op.", "Jun Op.")
turb_params_table_pt1 <- as.data.frame(turb_params_table_pt1)
turb_params_table_pt1 <- turb_params_table_pt1[order(turb_params_table_pt1$Species, turb_params_table_pt1$`Turbine model`),]

kbl(turb_params_table_pt1,booktabs=T, caption = "Monthly wind farm operational data (mean and 95 perc. range) is given for each wind farm specification.", row.names = F) %>%
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2,bold=T,color="blue",width = "0.65in") %>% 
  column_spec(3:8,width = "0.65in")

```
<br>
<br>

```{r, table7, echo=FALSE, warning=FALSE, message = FALSE}
num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
sampled_subset <- subset(
  params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][1]]][[1]],
  select=c(JulOp,AugOp,SepOp,OctOp,NovOp,DecOp))
# n_table_cols <- length(sampled_subset[1,])
n_table_cols_pt2 <- length(sampled_subset[1,])
col_names <- colnames(sampled_subset)
turb_params_table_pt2 <- mat.or.vec(num_species*num_turb_mods, (n_table_cols_pt2 + 2))

for(e in 1:num_species){
  for(i in 1:num_turb_mods){
    index_a <- (num_turb_mods*e) - (num_turb_mods - i)
    turb_params_table_pt2[index_a, 1] <- gsub("_", " ", params$model_output[['CRSpecies']][e])
    turb_params_table_pt2[index_a, 2] <- rev(params$model_output[['Turbines']])[i]

    for(z in 1:n_table_cols_pt2){
      turb_params_temp <- subset(
        params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][e]]][[num_turb_mods-(i-1)]], 
        select=c(JulOp,AugOp,SepOp,OctOp,NovOp,DecOp))[, z]
      mean_temp <- round(mean(turb_params_temp), 1)
      lower_temp <- round(quantile(turb_params_temp, c(.025)), 1)
      upper_temp <- round(quantile(turb_params_temp, c(.975)), 1)
      turb_params_table_pt2[index_a, (z + 2)] <- paste(mean_temp, " (", lower_temp, ", ", upper_temp, ")", sep="")
    }
  }
}

colnames(turb_params_table_pt2) <- c("Species", "Turbine model", "Jul Op.", "Aug Op.", "Sep Op.", "Oct Op.", "Nov Op.", "Dec Op.")
turb_params_table_pt2 <- as.data.frame(turb_params_table_pt2)
turb_params_table_pt2 <- turb_params_table_pt2[order(turb_params_table_pt2$Species, turb_params_table_pt2$`Turbine model`),]

kbl(turb_params_table_pt2, booktabs=T, caption = "Monthly wind farm operational data (mean and 95 perc. range) is given for each wind farm specification.", row.names = F) %>%
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T) %>% 
  column_spec(1,bold=T,color="red") %>% 
  column_spec(2,bold=T,color="blue",width = "0.65in") %>% 
  column_spec(3:8,width = "0.65in")

```
<br>
<br>
\newpage

```{r, fig1, fig.height = 7.5, echo=FALSE, warning=FALSE, message = FALSE, fig.cap = "A map of the species occurrence probabities and wind farm location.", fig.pos="t"}

wf_loc <- params$model_output[['sampledParamsTurbine']][[params$model_output[['CRSpecies']][1]]][[1]][1, c("Latitude", "Longitude")] 

windfarm_loc <- st_as_sf(as.data.frame(wf_loc), coords=c("Longitude", "Latitude"), crs=4326) %>% st_transform(3857)
map_extent <- st_union(windfarm_loc) %>% st_buffer(320000) %>% st_bbox()
map_extent_sm <- st_union(windfarm_loc) %>% st_buffer(280000) %>% st_bbox()

spp <- params$model_output[['CRSpecies']][1]
# load(file.path("data", paste0(spp, "_monthly_prob_BOEM_half_deg_trunc.RData")))
spp_move_occur <- st_as_sf(get(paste0(spp, "_monthly_prob_BOEM_half_deg_trunc"))) %>% st_transform(3857)

quants <- function(val) {
  #issue with zero inflated bins - need to generate non-zero quants
  non_zero_mean <- val[val>0]
  mean_bins <- c(0, quantile(non_zero_mean, probs=seq(0,1,1/7)))
  # mean_bins <- quantile(val, probs=seq(0,1,1/8))
  return(cut(val, mean_bins, labels = F, include.lowest = T, right = F))
}

quants_labels <- function(val) {
  non_zero_mean <- val[val>0]
  mean_bins <- c(0, quantile(non_zero_mean, probs=seq(0,1,1/7)))
  # mean_bins <- quantile(val, probs=seq(0,1,1/8))
  return(cut(val, mean_bins, ordered_result=T, include.lowest = T, right = F))
}

spp_move_occur$quant <- as.factor(quants(spp_move_occur$mean))
spp_move_occur$quant_labels <- quants_labels(spp_move_occur$mean)

fill_labels <- as.vector(levels(spp_move_occur$quant_labels))

shut_up(
  print(basemaps::basemap_ggplot(ext = map_extent, map_service = "esri", map_type = "world_ocean_base") +
          ggnewscale::new_scale("fill") +
          geom_sf(data = spp_move_occur, aes(fill=quant), alpha = 0.5) +
          # RColorBrewer::brewer.pal(9, name = "YlOrRd")
          # "#FFFFCC" "#FFEDA0" "#FED976" "#FEB24C" "#FD8D3C" "#FC4E2A" "#E31A1C" "#B10026"
          # "#FFFFCC" "#FFEDA0" "#FED976" "#FEB24C" "#FD8D3C" "#FC4E2A" "#E31A1C" "#BD0026" "#800026"
          # scale_fill_manual(values =fill_labels_colors) +
          scale_fill_manual(values =c("1" ="#FFFFCC", "2"="#FFEDA0", "3"="#FED976", "4"="#FEB24C", "5"="#FD8D3C",
                                      "6"="#FC4E2A", "7"="#E31A1C", "8"="#B10026"), labels=fill_labels) +
          ggnewscale::new_scale("color") +
          geom_sf(data = states_sf, aes(col="black"), fill=NA, show.legend = F) +
          geom_sf(data = BOEM_lease_outlines, aes(col="gray40"), fill=NA) +
          geom_sf(data = BOEM_planning_area_outlines, aes(col="gray80"), fill=NA) +
          geom_sf(data=windfarm_loc, aes(col="red"), fill=NA, size = 5, shape = 8) +
          scale_color_identity(labels = c(black = "State boundaries", gray40 = "BOEM wind leases", gray80="BOEM planning areas",
                                          red = "Wind farm location"), guide = "legend", ) +
          coord_sf(xlim = c(map_extent_sm[1],map_extent_sm[3]), ylim=c(map_extent_sm[2],map_extent_sm[4])) +
          ggtitle(paste(sub("_", " ", paste0(params$model_output[['CRSpecies']][1])), "mean summed monthly occurrence probability\n  and wind farm location.")) +
          theme_bw() +
          guides(color = guide_legend(nrow = 4), 
                 fill = guide_legend(nrow = 4)) +
          theme(axis.title = element_blank(), 
                legend.title = element_blank(),
                legend.position="bottom"))
  
)

  #There needs to be spaces between plots in R Markdown if they are to be given their own caption
  #https://stackoverflow.com/questions/52788015/looping-through-a-list-of-ggplots-and-giving-each-a-figure-caption-using-knitr
  cat('\n\n\n\n')

```

<br>
\newpage

## Results for the SCRAM simulation


```{r, table_out_1, echo=FALSE, warning=FALSE, message = FALSE,  results = "asis"}

num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
all_models_summary <- data.frame()
for(q in 1:num_species){
  for(i in 1:num_turb_mods){
    spp <- sub("_", " ",params$model_output[['CRSpecies']][q])
    turb <- params$model_output[['Turbines']][i]
    
    model_out <- params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][q]]][[i]]
    
    model_out_melt <- reshape2::melt(model_out, value.name = "coll_rate")
    model_out_melt <- model_out_melt %>% 
      dplyr::rename("month"="variable")
    model_out_melt$iter <- rep(seq(1:length(model_out$Jan)), 12)
    
    #calculate mean and 95% CI  
    model_summary <- model_out_melt %>% 
      dplyr::group_by(month) %>% 
      dplyr::summarise(`Mean number of collisions` = as.character(round(mean(coll_rate, na.rm = T), 3)), 
                       `Lower pred. interval` = as.character(round(quantile(coll_rate, c(0.025), na.rm=TRUE), 3)),
                       `Upper pred. interval` = as.character(round(quantile(coll_rate, c(0.975), na.rm=TRUE), 3))) %>% 
      replace_na(list(`Mean number of collisions`="", `Lower pred. interval`="", `Upper pred. interval`="")) %>% 
      mutate_if(is.character,
                str_replace_all, pattern = "NaN", replacement = "") %>% 
      mutate(month = as.character(month))
    
    #calculate annual summary of model runs, mean of sum of posteriors and then quantiles of these sums for predict interval
    annual_summary <- model_out_melt %>% 
      dplyr::group_by(iter) %>% 
      dplyr::summarise(sum_monthly = sum(coll_rate, na.rm = T))
    
    annual_rate <- c("annual", round(mean(annual_summary$sum_monthly, na.rm=TRUE), 3),
                     round(quantile(annual_summary$sum_monthly, c(0.025), na.rm=TRUE), 3),
                     round(quantile(annual_summary$sum_monthly, c(0.975), na.rm=TRUE), 3))
    
    # model_summary$month <- as.character(model_summary$month)
    # annual_collision_rate_melt <- reshape2::melt(model_out, value.name = "coll_rate") %>% 
    #   dplyr::rename("Time period"="variable")
    # 
    # annual_collision_rate <- sum(annual_collision_rate_melt$coll_rate, na.rm=T)
    # annual_lower_coll_rate <- quantile(annual_collision_rate_melt$coll_rate, c(0.025), na.rm=TRUE)
    # annual_upper_coll_rate <- quantile(annual_collision_rate_melt$coll_rate, c(0.975), na.rm=TRUE)
    # annual_rate <-c("Annual",round(annual_collision_rate, 3), round(annual_lower_coll_rate, 3), round(annual_upper_coll_rate, 3))
    model_summary <- rbind(model_summary, annual_rate)    
    model_summary <- cbind(Species = spp, `Turbine model` = turb, model_summary)
    all_models_summary <- rbind(all_models_summary, model_summary)
    
  }
}

kbl(all_models_summary, booktabs=T, caption = "The predicted mean and 95 perc. prediction intervals of the number of collisions per month and the total summed monthly number of collisions and 95 perc. prediction interval. Results are not shown for months that do not have movement data.") %>%
  kable_styling(position="left", full_width=F, latex_options = c("HOLD_position", "striped")) %>% 
  row_spec(0,bold=T, extra_css = "vertical-align:text-bottom	;") %>% 
  column_spec(1,bold=T,color="red", width = "1.25in") %>% 
  column_spec(2,bold=T,color="blue",width = "1in") %>% 
  column_spec(3:6,width = "0.75in")

```

\newpage

```{r, fig2, fig.height = 4, echo=FALSE, warning=FALSE, message = FALSE, fig.cap = "A frequency histogram of the total number of collisions per year. The heights of the bars show the relative frequency of each value. Months for which movement data were provided or available are shown in bold; only bold months are shown in histogram of annual collisions.", fig.pos="t"}

num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
for(q in 1:num_species){
  for(i in 1:num_turb_mods){
    if(!is.null(params$model_output$monthCollsnReps_opt1)){
      # if(sum(params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][q]]][[i]], na.rm=TRUE)>0){
        NA_index <- which(is.na(params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][q]]][[i]][1,]))
        outvector <- round(rowSums(params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][q]]][[i]], na.rm = TRUE))
        xmin <- round(min(outvector, na.rm=TRUE))
        xmax <- round(max(outvector, na.rm=TRUE))
        freq_outvector <- table(outvector)

        if (sum(outvector)==0){
          #no collisions provide a modified figure
          no_coll = T
          plot_xmin = 0
          plot_xmax = 10
          plot_ymin = 0
          plot_ymax = 10
          x_ann = 5
          y_ann = 5
          fig_text = "No collisions predicted"
          
        } else {
          plot_xmin = -1
          if (xmax + 2 < 10){
            plot_xmax = 10
          } else {plot_xmax = xmax + 2}
          plot_ymin = 0
          plot_ymax = freq_outvector[[1]]/sum(freq_outvector)*1.1  #calculate frequency of first element to set as max y
          x_ann = 0
          y_ann = 0
          fig_text = ""
        }
        
        #main plot title
        if(length(which(params$species_labels[,q] == params$model_output[['CRSpecies']][q]))>0){
          main_label <- paste(params$species_labels[params$species_labels[,1] == params$model_output[['CRSpecies']][q], 2], " (turbine model ", params$model_output[['Turbines']][i], ")", sep="")
        }else{
          main_label <- paste(params$model_output[['CRSpecies']][q],  " (turbine model ", params$model_output[['Turbines']][i], ")", sep="")
        }
        
        bold <- rep(2, 12)
        month_col <- rep("dark blue", 12)
        month_col[NA_index] <- rgb(0, 0, 0, 0.8)
        bold[NA_index] <- 1 # make bold those months with data
        p1 <- ggplot(data.frame(outvector=outvector), aes(outvector)) + 
          #center on integers use binwidth = 1 and center = 0; but modified to make bar end at number for thresholding
          stat_bin(bins=12, aes(y = stat(count / sum(count))), col="darkgreen", fill="darkgreen", binwidth = 0.5, center = 0.5) +
          # annotate("rect", xmin=-0.5, xmax=params$threshold, ymin=0, ymax=1, fill=rgb(1, 1, 1, 0.65), col=rgb(0, 0, 0, 0)) +
          # geom_density(adjust=3, trim = T) +
          ggtitle(main_label) +
          scale_x_continuous(breaks=scales::pretty_breaks()) +
          xlim(c(plot_xmin, plot_xmax)) +
          ylim(c(plot_ymin, plot_ymax)) +
          xlab("Total collisions per year over months highlighted below") +
          ylab("Frequency") +
          annotate("text", x=x_ann, y=y_ann, label = fig_text) +
          geom_vline(xintercept = params$threshold, color = "red", linetype = "dashed") +
          annotate("text", x=params$threshold, y=plot_ymax*0.5, col="red", label = "Input threshold", angle=90, vjust=1.5) +
          theme_classic()
        
        print(cowplot::ggdraw(cowplot::add_sub(p1, label = month.abb, x=seq(0.1,0.9,0.8/11), color = month_col, size = 10, fontface = bold)))
      # }else{
      #   ggplot() +
      #     theme_void() +
      #     geom_text(aes(0,0,label="This plot left intentionally blank.\nOption not run.")) +
      #     xlab(NULL) #optional, but safer in case another theme is applied later
      # }
      #There needs to be spaces between plots in R Markdown if they are to be given their own caption
      #https://stackoverflow.com/questions/52788015/looping-through-a-list-of-ggplots-and-giving-each-a-figure-caption-using-knitr
      cat('\n\n')

    }
  }
    # cat('\n\n')

}

```

\newpage

```{r, fig3, fig.height = 4, echo=FALSE, warning=FALSE, message = FALSE, fig.cap="The predicted mean and 95 perc. prediction intervals of the number of collisions per month. Results are not shown for months that do not have movement data."}

num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
for(q in 1:num_species){
  for(i in 1:num_turb_mods){
    
  # model_out <- params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][1]]][[1]]
  model_out <- params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][q]]][[i]]

  #main label creation
  if(length(which(params$species_labels[,1] == params$model_output[['CRSpecies']][q]))>0){
    main_label <- paste(
      params$species_labels[params$species_labels[,1] == params$model_output[['CRSpecies']][q], 2], 
      " (turbine model ", params$model_output[['Turbines']][i], ")", sep=""
    )
  }else{
    main_label <- paste(params$model_output[['CRSpecies']][q], 
                        " (turbine model ", params$model_output[['Turbines']][i], ")", sep="")
  }
  
  model_out_melt <- reshape2::melt(model_out, value.name = "coll_rate")
  model_out_melt <- model_out_melt %>% 
    dplyr::rename("month"="variable")
  model_out_melt$iter <- rep(seq(1:length(model_out$Jan)), 12)
  
  #calculate mean and 95% CI  
  model_summary <- model_out_melt %>% 
    dplyr::group_by(month) %>% 
    dplyr::summarise(mean_coll_rate = mean(coll_rate, na.rm = T), 
              lower_coll_rate = quantile(coll_rate, c(0.025), na.rm=TRUE),
              upper_coll_rate = quantile(coll_rate, c(0.975), na.rm=TRUE)
              )
  #determine max upper to give a bit more space to the y axis
  max_upper <-  max(model_summary$upper_coll_rate, na.rm = T)
  y_limit <- ceiling(max_upper + max_upper * 0.25) 
  
  print(ggplot(model_summary) +
    geom_point(aes(x=month, y=mean_coll_rate)) +
    geom_linerange(aes(x = month, ymin = lower_coll_rate, ymax = upper_coll_rate)) + 
    ggtitle(main_label, ) +
    ylab("Number of collisions/month") +
    expand_limits(y=y_limit) +
    theme_classic() + 
    theme(axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)
    ))
  cat('\n\n')

  }
}

```

\newpage

```{r, fig4, fig.height = 4, echo=FALSE, warning=FALSE, message = FALSE, fig.cap="The mean number of collisions per month for each turbine model combination. A sample of 100 runs of the of simulation are plotted showing the typical variation among iterations. The iterations among this set that exceed the user-specified threshold for the number of collisions, if set, are shown in red; iterations below this threshold are shown in blue. Since the threshold is a yearly value, the threshold here is that value divided by 12. The annual and monthly mean (95 perc. prediction interval) for al iterations are shown at top (annual) and for each month to the right of the plot. "}

num_species <- length(params$model_output[['CRSpecies']])
num_turb_mods <- length(params$model_output[['Turbines']])
for(q in 1:num_species){
  for(i in 1:num_turb_mods){
    full_model_results <- params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][q]]][[i]]
    model_out_100 <- full_model_results[1:100, ]
    model_out_100_melt <- reshape2::melt(model_out_100, value.name = "coll_rate")
    model_out_100_melt <- model_out_100_melt %>% 
      dplyr::rename("month"="variable")
    model_out_100_melt$iter <- rep(seq(1:length(model_out_100$Jan)), 12)
    #color values above threshold differently
    model_out_100_melt$exceed_threshold <- "below"
    model_out_100_melt[which(model_out_100_melt$coll_rate > (params$threshold/12)), "exceed_threshold"] <- "above"
    
    #reverse month order
    model_out_100_melt$month <- factor(model_out_100_melt$month, levels = rev(month.abb))
    
    #determine max upper to give a bit more space to the y axis
    max_upper <-  max(model_out_100_melt$coll_rate, na.rm = T)
    y_limit <- ceiling(max_upper + max_upper * 0.2) 
    
    # #calculate mean and 95% CI for each month for 100 iters
    # model_100_summary <- model_out_100_melt %>%
    #   dplyr::group_by(month) %>%
    #   dplyr::summarise(mean_coll_rate = mean(coll_rate, na.rm = T),
    #             lower_coll_rate = quantile(coll_rate, c(0.025), na.rm=TRUE),
    #             upper_coll_rate = quantile(coll_rate, c(0.975), na.rm=TRUE)) %>%
    #   dplyr::mutate(mean_95CI =  paste(round(mean_coll_rate, 2), " (", round(lower_coll_rate, 2),
    #                             ", ", round(upper_coll_rate, 2), ")", sep = ""))

    annual_collision_rate_melt <- reshape2::melt(full_model_results, value.name = "coll_rate") %>% 
      dplyr::rename("month"="variable")
    
    #calculate mean and 95% CI for each month for all iters
    monthly_collision_rate_summary <- annual_collision_rate_melt %>% 
      dplyr::group_by(month) %>% 
      dplyr::summarise(mean_coll_rate = mean(coll_rate, na.rm = T), 
                       lower_coll_rate = quantile(coll_rate, c(0.025), na.rm=TRUE),
                       upper_coll_rate = quantile(coll_rate, c(0.975), na.rm=TRUE)) %>% 
      dplyr::mutate(mean_95CI =  paste(round(mean_coll_rate, 3), " (", round(lower_coll_rate, 3), 
                                       ", ", round(upper_coll_rate, 3), ")", sep = ""))
    
    monthly_collision_rate_summary[which(is.na(monthly_collision_rate_summary$lower_coll_rate)), "mean_95CI"] <- NA   
    
    #P. Loring requested annual collision rate. 
    annual_collision_rate <- mean(annual_collision_rate_melt$coll_rate, na.rm=T)
    annual_lower_coll_rate <- quantile(annual_collision_rate_melt$coll_rate, c(0.025), na.rm=TRUE)
    annual_upper_coll_rate <- quantile(annual_collision_rate_melt$coll_rate, c(0.975), na.rm=TRUE)
    annual_collision_rate_txt <- paste("Mean annual rate and 95 perc. prediction interval: ",round(annual_collision_rate, 3), 
                                       " (", round(annual_lower_coll_rate, 3), 
                                       ", ", round(annual_upper_coll_rate, 3), ")", sep = "")
        
    #main plot title
    if(length(which(params$species_labels[,q] == params$model_output[['CRSpecies']][q]))>0){
      main_label <- paste(params$species_labels[params$species_labels[,1] == params$model_output[['CRSpecies']][q], 2], " (turbine model ", params$model_output[['Turbines']][i], ")", sep="")
    }else{
      main_label <- paste(params$model_output[['CRSpecies']][q],  " (turbine model ", params$model_output[['Turbines']][i], ")", sep="")
    }
    
    #must use print for ggplot in rmarkdown file in a loop as it otherwise does not get outputted to the doc
    print(ggplot(model_out_100_melt) +
      geom_jitter(aes(x=month, y=coll_rate, col=exceed_threshold), width = 0.05, height = 0.05) +
      # annotate("text", x="Feb", y=y_limit*0.5, label = annual_collision_rate_txt) +
      # geom_text(data=model_100_summary, aes(x=month, y=y_limit*0.9, label=mean_95CI), hjust=0.9) +
      geom_text(data=monthly_collision_rate_summary, aes(x=month, y=y_limit*1.05, label=mean_95CI), hjust=0.9) +
      ggtitle(main_label, subtitle = annual_collision_rate_txt) +
      ylab("Number of collisions/month") +
      scale_y_continuous(limits = c(0, y_limit), oob = scales::squish) +
      expand_limits(y=y_limit) +
      coord_flip() +
      scale_colour_manual(values = c("darkred", "blue")) +
      theme_classic() + 
      theme(axis.title.y = element_blank(),
            plot.title = element_text(hjust = 0.5),
            plot.subtitle = element_text(hjust = 0.5),
            legend.position = "none"
      ))
    cat('\n\n')

  }
}

```
<br>

<!-- Below is confusing. Strike for now. -->
<!-- \newpage -->

<!-- ```{r, fig5, fig.height = 4, echo=FALSE, warning=FALSE, message = FALSE, fig.cap="If multiple turbine models were run, this space shows histograms comparing the difference in the total number of collisions per year between models. The y-axis shows the relative frequency (0-1) among iterations of each value for the difference between models, labeled by their power output. If the entire histogram lies above zero, the number of collisions was always higher for model listed first. "} -->
<!-- #100322 - ATG Fixed error comparing options, these were swapped relative to the caption -->
<!-- num_turb_mods <- length(params$model_output[['Turbines']]) -->
<!-- if(num_turb_mods>1){ -->
<!--   #generate combination of turbine pairs -->
<!--   turbs_pair <- combn(num_turb_mods, 2) -->

<!--   for(i in 1:min(length(turbs_pair[1,]), 10)){ -->
<!--     data_run1 <- rowSums(params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][1]]][[turbs_pair[1,i]]], na.rm=TRUE) -->
<!--     data_run2 <- rowSums(params$model_output[[as.numeric(params$option)]][[params$model_output[['CRSpecies']][1]]][[turbs_pair[2,i]]], na.rm=TRUE) -->
<!--     data_diff <- data_run1 - data_run2 -->
<!--     #check to see if any difference, if there is one, plot - need only be one true difference (thus sum) -->
<!--     if(sum(data_diff > 0) > 1 | sum(data_diff < 0) > 1){ -->
<!--       if(length(which(params$species_labels[,1] == params$model_output[['CRSpecies']][1]))>0){ -->
<!--         main_label <- paste(params$species_labels[params$species_labels[,1] == params$model_output[['CRSpecies']][1], 2], " (turbine model ", params$model_output[['Turbines']][turbs_pair[1,i]], " - model ", params$model_output[['Turbines']][turbs_pair[2,i]], ")", sep="") -->
<!--       }else{ -->
<!--         main_label <- paste(params$model_output[['CRSpecies']][1], " (turbine model ", params$model_output[['Turbines']][turbs_pair[2,i]], " - model ", params$model_output[['Turbines']][turbs_pair[1,i]], ")", sep="") -->
<!--       } -->

<!--       print(ggplot(data.frame(data_diff=data_diff), aes(data_diff)) +  -->
<!--               #center on integers use binwidth = 1 and center = 0; but modified to make bar end at number for thresholding -->
<!--               stat_bin(bins=12, aes(y = stat(count / sum(count))), col="darkgreen", fill="darkgreen", binwidth = 1, center = 0.5) + -->
<!--               ggtitle(main_label) + -->
<!--               xlab("Difference in number of collisions/year") + -->
<!--               ylab("Relative frequency") + -->
<!--               theme_classic() +  -->
<!--               theme(plot.title = element_text(hjust = 0.5), -->
<!--                     legend.position = "none" -->
<!--               )) -->
<!--     } else { -->
<!--       ggplot() + -->
<!--         theme_void() + -->
<!--         geom_text(aes(0,0,label="No difference in turbine model specified.")) + -->
<!--         xlab(NULL) #optional, but safer in case another theme is applied later -->
<!--       } -->
<!--   } -->
<!-- } else { -->
<!--   ggplot() + -->
<!--     theme_void() + -->
<!--     geom_text(aes(0,0,label="This plot left intentionally blank.\nOnly one turbine model specified.")) + -->
<!--     xlab(NULL) #optional, but safer in case another theme is applied later -->
<!-- } -->
<!-- cat('\n\n') -->


<!-- ``` -->

<!-- <br> -->